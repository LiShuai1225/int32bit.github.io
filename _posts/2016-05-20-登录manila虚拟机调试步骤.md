---
layout: post
title: 登录manila虚拟机调试步骤
catalog: true
tags:
     - openstack
     - manila
---

manila文件共享服务的实现原理是先创建一个虚拟机以及volume，volume大小取决于用户创建manila实例指定的大小. 然后把volume挂载到虚拟机中(包括nova attach以及虚拟机内部的mount操作)。虚拟机是基于一个特殊的镜像启动的，这个镜像安装了NFS服务器，因此最后一步就是通过NFS把挂载的volume export，可以进入虚拟机查看`/etc/exports`。

为了节约资源，并不是每一个manila实例都需要创建一个虚拟机，如果使用的同一个共享网络,多个实例可共享一个虚拟机实例,此时一个虚拟机会同时挂载多个volume。

文件共享服务manila不仅依赖外部环境，比如虚拟机是否创建成功，volume是否挂载成功等，还依赖于其内部环境，比如NFS服务器是否启动成功，export是否正常等。假设外部依赖环境没有问题，此时manila实例状态为available，文件共享失败，则需要通过ssh进入vm内部进行调试，过程基本包括以下几个步骤：

## 1.使用manila list获取需要处理的实例id和share ip

进入API节点:

```bash
manila list
```

以上能够获取manila实例`id`以及通过`Export locatio`获取`share ip`，需要记录下来待后续使用，比如id=`8fcdf11d-98d3-4659-af28-733a36f102d2`，ip=`10.240.0.20`。

##2.通过manila id获取虚拟机名称

```bash
VM_NAME=$(manila show 8fcdf11d-98d3-4659-af28-733a36f102d2 2>/dev/null | grep share_server_id | awk '{print $4}')
```

注意manila的字段`share_server_id`其实并不是虚拟机`id`，而是`name`，所以不能直接使用`nova show`获取虚拟机信息，而必须先根据虚拟机的`name`获取虚拟机`id`:

```bash
VM_ID=$(nova list --all-tenants --fields name 2>/dev/null | grep $VM_NAME  | awk '{print $2}')
```

## 3. 通过虚拟机id获取网卡id

```bash
nova interface-list $VM_ID 2>/dev/null | grep --color=auto -P '\w{8}-\w{4}' | awk '{print $6}' # get netid
```
返回

```
a276df5d-4b35-4a85-8405-b5489afe6db6
```
以上返回的`netid`，需要记录,后面要用。

## 4. 获取网卡所在的netns

进入网络节点，然后根据以上返回的`netid`找到对应的`netns`：

```bash
ip netns ls | grep a276df5d-4b35-4a85-8405-b5489afe6db6
```
返回:

```
qdhcp-a276df5d-4b35-4a85-8405-b5489afe6db6
```

以上`a276df5d-4b35-4a85-8405-b5489afe6db6`为`netid`，返回了`netns`。

## 5. 进入netns

```bash
ip netns exec qdhcp-a276df5d-4b35-4a85-8405-b5489afe6db6 bash
```

检查是否能够ping通share ip:

```
$ ping -c 2 -w 2 10.240.0.20
PING 10.240.0.20 (10.240.0.20) 56(84) bytes of data.
64 bytes from 10.240.0.20: icmp_seq=1 ttl=64 time=1.39 ms
64 bytes from 10.240.0.20: icmp_seq=2 ttl=64 time=0.332 ms
--- 10.240.0.20 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1001ms
rtt min/avg/max/mdev = 0.332/0.861/1.390/0.529 ms

```
## 6. ssh登录虚拟机

首先获取虚拟机的密码:

```bash
cat /etc/manila/manila.conf | grep instance_password
```

此时可以通过ssh登录了，注意用户名为ubuntu，不是root:

```
ssh ubuntu@10.240.0.20
```
