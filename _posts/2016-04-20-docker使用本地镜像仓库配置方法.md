---
layout: post
title: docker使用本地镜像仓库配置方法
subtitle: 使用harbor做registry mirror
catalog: true
tag:
    - docker
    - registry
    - harbor
---

我们部署了基于Harbor的本地镜像仓库，只需要简单设置下，使用`docker pull`不用每次都消耗大量时间往dockerhub拉取镜像了，使用我们的仓库，几十秒内就可以拉取golang镜像（包括解压缩），如图：

![pull截图](/img/posts/docker使用本地镜像仓库配置方法/pull.png)

以上还包括了docker往dockerhub拉取index信息以及解压缩的时间，实际下载时间花费不到10秒。

配置前请确保部署好了registry，可以直接使用harbor部署，部署方法参考[docker镜像仓库harbor快速部署和使用](http://int32bit.github.io/2016/04/18/docker镜像仓库harbor快速部署和使用/),本地只需要两步：

## 1.配置docker

修改`docker daemon`启动参数，ubuntu下是`/etc/default/docker`：

```bash
DOCKER_OPTS="$DOCKER_OPTS --registry-mirror=http://42.62.xx.xx --insecure-registry 42.62.xx.xx"
```

其中`42.62.xx.xx`是我们仓库的地址！

## 2. 重启docker

```bash
sudo service docker restart
```

## FAQ

#### (1) docker客户端是否需要登录？

只要是拉取的是公开的仓库，不需要登录！若你有私有仓库，则需要登录。通常我们不需要登录。

#### (2) 为什么有时仓库中已经存在的镜像，我还是从dockerhub里拉取？

这是由于我们的镜像仓库目前还不支持自动往dockerhub同步，可能导致dockerhub的镜像更新了，本地仓库的镜像过时了，因此会从dockerhub拉取最新镜像并自动同步到本地仓库中。

#### (3) 使用本地镜像就不需要和dockerhub连接了吗？

需要，在下载前，docker需要往dockerhub拉取index信息，不过这个数据量很小，不会影响我们的速度。

#### (4) 连接时出现443认证错误，怎么回事？

我们的仓库使用http协议连接，没有开启https，老版本docker 客户端可能默认使用https协议，因此出错。

#### (5) 我dockerhub的自己的镜像也能缓存吗？

可以，但是必须预先建立自己的project，比如你在dockerhub的用户名是foobar，在harbor中也必须存在foobar这个项目，目前harbor不支持自动创建项目，已提交[issues#131](https://github.com/vmware/harbor/issues/131).
