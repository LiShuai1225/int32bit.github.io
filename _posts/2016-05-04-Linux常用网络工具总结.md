# Linux常用网络工具总结

总结了一些常用的Linux网络工具。

## ping

这个命令不用多说，我们通常使用这个命令判断网络的连通性，偶尔还顺带当做域名解析使用（查看域名的IP）：

```bash
ping google.com

```
默认使用该命令会一直发送ICMP包直到用户中止，可以使用`-c`命令指定发送数据包的个数，使用`-W`指定等待最长时间,如果有多张网卡，可以通过`-I`指定使用哪个网卡。

```bash
fgp@controller:~$ ping -c 2 -I eth0 -W 2 baidu.com
ping: Warning: source address might be selected on device other than eth0.
PING baidu.com (111.13.101.208) from 192.168.56.2 eth0: 56(84) bytes of data.
From controller (192.168.56.2) icmp_seq=1 Destination Host Unreachable
From controller (192.168.56.2) icmp_seq=2 Destination Host Unreachable

--- baidu.com ping statistics ---
2 packets transmitted, 0 received, +2 errors, 100% packet loss, time 1008ms
pipe 2

```
以上命令会由eth0网卡发送两个包，并且最长等待2秒时间，执行完后会自动退出。
另外在ping过程中，如果按下`ctrl+|`会打印出当前的summary信息，即有多少个包丢掉了、响应时间等。

## netstat

这个命令也经常使用，可以查看当前建立的网络连接。最经典的案例就是查看系统打开了哪些端口：

```bash
fgp@controller:~$ sudo netstat -lnpt
[sudo] password for fgp:
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 0.0.0.0:3306            0.0.0.0:*               LISTEN      2183/mysqld
tcp        0      0 0.0.0.0:11211           0.0.0.0:*               LISTEN      2506/memcached
tcp        0      0 0.0.0.0:9292            0.0.0.0:*               LISTEN      1345/python
tcp        0      0 0.0.0.0:6800            0.0.0.0:*               LISTEN      2185/ceph-osd
tcp        0      0 0.0.0.0:6801            0.0.0.0:*               LISTEN      2185/ceph-osd
tcp        0      0 0.0.0.0:28017           0.0.0.0:*               LISTEN      1339/mongod
tcp        0      0 0.0.0.0:6802            0.0.0.0:*               LISTEN      2185/ceph-osd
tcp        0      0 0.0.0.0:6803            0.0.0.0:*               LISTEN      2185/ceph-osd
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1290/sshd
```

另外使用netstat还可以查看路由表：

```
fgp@controller:~$ sudo netstat -nr
Kernel IP routing table
Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface
0.0.0.0         192.168.1.1     0.0.0.0         UG        0 0          0 brqcb225471-1f
172.17.0.0      0.0.0.0         255.255.0.0     U         0 0          0 docker0
192.168.1.0     0.0.0.0         255.255.255.0   U         0 0          0 brqcb225471-1f
192.168.56.0    0.0.0.0         255.255.255.0   U         0 0          0 eth1
```
以上`Genmask`为`0.0.0.0`的表示默认路由，即连接外网的路由。

## lsof

`lsof`命令用来查看打开的文件，由于在Linux中一切皆文件，那socket、pipe等也是文件，因此能够查看网络连接以及网络设备，其中和网络最相关的是`-i`选项，它指定符合条件的进程（4、6、协议、:端口、 @ip等），它的格式为`[46][protocol][@hostname|hostaddr][:service|port]`,比如查看22端口有没有打开，哪个进程打开的:

```
fgp@controller:~$ sudo lsof -i :22
COMMAND  PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
sshd    1290 root    3u  IPv4  10300      0t0  TCP *:ssh (LISTEN)
sshd    1290 root    4u  IPv6  10302      0t0  TCP *:ssh (LISTEN)
```
可见22端口是sshd这个命令，其进程号pid为1290打开的。

可以指定多个条件，但默认是OR关系的，如果是AND关系，使用`-a`参数，比如查看22端口并且使用Ipv6连接的进程：

```
fgp@controller:~$ sudo lsof -c sshd -i 6 -a -i :22
COMMAND  PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
sshd    1290 root    4u  IPv6  10302      0t0  TCP *:ssh (LISTEN)
```
列出所有与`192.168.56.1`（我的宿主机IP地址）的ipv4连接：

```
fgp@controller:~$ sudo lsof -i 4@192.168.56.1
COMMAND  PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
sshd    2299 root    3u  IPv4  14047      0t0  TCP controller:ssh->mac:54558 (ESTABLISHED)
sshd    2377  fgp    3u  IPv4  14047      0t0  TCP controller:ssh->mac:54558 (ESTABLISHED)
```

## iftop

用过`top`以及`iotop`，那`iftop`也能猜到其功能，用于查看网络流量：

```bash
sudo iftop
```

![iftop](/Users/fuguangping/github/int32bit.github.io/img/posts/Linux常用网络工具总结/iftop.png)

## nc

nc(netcat)被称为网络工具的瑞士军刀，常常作为网络应用的Debug分析器，可以根据需要创建各种不同类型的网络连接。一个经典的用法是用于端口扫描。比如我要扫描192.168.56.2主机1-100端口，哪些是打开的：

```
fgp@controller:~$ nc -zv 192.168.56.2 1-100 |& grep 'succeeded!'
Connection to 192.168.56.2 22 port [tcp/ssh] succeeded!
Connection to 192.168.56.2 80 port [tcp/http] succeeded!
```
由此可见，该主机打开了22和80端口。

可参看封装了nc的[端口扫描工具](https://github.com/int32bit/portscanner)以及其他的一些[nc命令实例](https://github.com/int32bit/notes/blob/master/linux/nc%E5%91%BD%E4%BB%A4%E5%AE%9E%E4%BE%8B.md)

## tcpdump

`tcpdump`(dump traffic on a network)是一个强大的抓包工具，不要被它的名称误导以为只能抓取tcp包，它能抓任何包。比如我们需要抓取目标主机是192.168.56.1，通过端口22的数据包：

```
sudo tcpdump -n -i eth1 'dst host 192.168.56.1 && port 22'
```
输出为：

```
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth1, link-type EN10MB (Ethernet), capture size 65535 bytes
23:57:39.507490 IP 192.168.56.2.22 > 192.168.56.1.54558: Flags [P.], seq 3010719012:3010719120, ack 1116715283, win 354, options [nop,nop,TS val 1049052 ecr 187891473], length 108
23:57:39.507607 IP 192.168.56.2.22 > 192.168.56.1.54558: Flags [P.], seq 108:144, ack 1, win 354, options [nop,nop,TS val 1049052 ecr 187891473], length 36
23:57:39.507784 IP 192.168.56.2.22 > 192.168.56.1.54558: Flags [P.], seq 144:252, ack 1, win 354, options [nop,nop,TS val 1049052 ecr 187891476], length 108
```
抓取HTTP包:

```
sudo tcpdump  -XvvennSs 0 -i eth0 tcp[20:2]=0x4745 or tcp[20:2]=0x4854
```
其中`0x4745`为"GET"前两个字母"GE",0x4854 为"HTTP"前两个字母"HT"。

指定`-A`以ACII码输出数据包，使用`-c`指定抓取包的个数。

## telnet

telnet协议客户端，有时也用来探测端口是否打开，比如本地端口22是否打开：

```
fgp@controller:~$ telnet localhost 22
Trying ::1...
Connected to localhost.
Escape character is '^]'.
SSH-2.0-OpenSSH_6.6.1p1 Ubuntu-2ubuntu2.6
```

可见成功连接到localhost的22端口，说明端口已经打开，还输出了banner信息。

## ifconfig

ifconfig也是比较熟悉的，用于查看网卡信息，比如IP地址、发送包的个数、接收包的个数、丢包个数等。

查看网卡ip地址：

```
fgp@controller:~$ ifconfig eth0
eth0      Link encap:Ethernet  HWaddr 08:00:27:c9:b4:f2
          inet6 addr: fe80::a00:27ff:fec9:b4f2/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:27757 errors:0 dropped:0 overruns:0 frame:0
          TX packets:589 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:10519777 (10.5 MB)  TX bytes:83959 (83.9 KB)
```
为网卡eth0增加一个新的地址（虚拟网卡）：

```
fgp@controller:~$ sudo ifconfig eth0:0 10.103.240.2/24
fgp@controller:~$ ifconfig eth0:0
eth0:0    Link encap:Ethernet  HWaddr 08:00:27:c9:b4:f2
          inet addr:10.103.240.2  Bcast:10.103.240.255  Mask:255.255.255.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
```

关闭网卡以及开启网卡：

```
sudo ifconfig eth0 down
sudo ifconfig eth0 up
```

### nslookup & dig

nslookup用于解析域名，比如查看google.com的ip地址：

```
fgp@controller:~$ nslookup google.com
Server:         114.114.114.114
Address:        114.114.114.114#53

Non-authoritative answer:
Name:   google.com
Address: 37.61.54.158
```

查看使用的DNS服务器地址：

```
fgp@controller:~$ nslookup
> server
Default server: 114.114.114.114
Address: 114.114.114.114#53
Default server: 8.8.8.8
Address: 8.8.8.8#53
```
dig命令也是域名解析工具，不过提供的信息更全面：

```
fgp@controller:~$ dig google.com

; <<>> DiG 9.9.5-3ubuntu0.8-Ubuntu <<>> google.com
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 53828
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 4, ADDITIONAL: 4

;; QUESTION SECTION:
;google.com.                    IN      A

;; ANSWER SECTION:
google.com.             2730    IN      A       37.61.54.158

;; AUTHORITY SECTION:
google.com.             10204   IN      NS      ns2.google.com.
google.com.             10204   IN      NS      ns4.google.com.
google.com.             10204   IN      NS      ns3.google.com.
google.com.             10204   IN      NS      ns1.google.com.

;; ADDITIONAL SECTION:
ns1.google.com.         86392   IN      A       216.239.32.10
ns2.google.com.         80495   IN      A       216.239.34.10
ns3.google.com.         85830   IN      A       216.239.36.10
ns4.google.com.         13759   IN      A       216.239.38.10

;; Query time: 17 msec
;; SERVER: 114.114.114.114#53(114.114.114.114)
;; WHEN: Thu May 05 00:11:48 CST 2016
;; MSG SIZE  rcvd: 180
```

## whois

whois用于查看域名所有者的信息，比如注册邮箱、手机号码、域名服务商等：

```
fgp@controller:~$ whois coolshell.cn
Domain Name: coolshell.cn
ROID: 20090825s10001s91994755-cn
Domain Status: ok
Registrant ID: hc401628324-cn
Registrant: 陈皓
Registrant Contact Email: haoel@hotmail.com
Sponsoring Registrar: 阿里云计算有限公司（万网）
Name Server: f1g1ns1.dnspod.net
Name Server: f1g1ns2.dnspod.net
Registration Time: 2009-08-25 00:40:26
Expiration Time: 2020-08-25 00:40:26
DNSSEC: unsigned
```
我们发现`coolshell.cn`这个域名是陈皓在万网购买注册的，注册时间是2009年，注册邮箱是`haoel@hotmail.com`

## route

route命令用于查看和修改路由表：

查看路由表:

```
fgp@controller:~$ sudo route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.1.1     0.0.0.0         UG    100    0        0 brqcb225471-1f
172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 brqcb225471-1f
192.168.56.0    0.0.0.0         255.255.255.0   U     0      0        0 eth1
```

增加/删除路由分别为`add`/`del`子命令,比如删除默认路由：

```
sudo route del default
```
增加默认路由，网关为192.168.1.1，网卡为brqcb225471-1f：

```
sudo route add default gw 192.168.1.1 dev brqcb225471-1f
```

## ip

ip命令可以说是最强大了，它可以替换`ifconfig`、`netstat`、`route`、`arp`等命令，比如查看网卡eth1 IP地址：

```
fgp@controller:~$ sudo ip addr ls  dev eth1
3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 08:00:27:9a:d5:d1 brd ff:ff:ff:ff:ff:ff
    inet 192.168.56.2/24 brd 192.168.56.255 scope global eth1
       valid_lft forever preferred_lft forever
    inet6 fe80::a00:27ff:fe9a:d5d1/64 scope link
       valid_lft forever preferred_lft forever
```

查看网卡eth1配置：

```
fgp@controller:~$ sudo ip link ls eth1
3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000
    link/ether 08:00:27:9a:d5:d1 brd ff:ff:ff:ff:ff:ff
```
查看路由：

```
fgp@controller:~$ ip route
default via 192.168.1.1 dev brqcb225471-1f
172.17.0.0/16 dev docker0  proto kernel  scope link  src 172.17.0.1
192.168.1.0/24 dev brqcb225471-1f  proto kernel  scope link  src 192.168.1.105
192.168.56.0/24 dev eth1  proto kernel  scope link  src 192.168.56.2
```
查看arp地址：

```
fgp@controller:~$ sudo ip neigh
192.168.56.1 dev eth1 lladdr 0a:00:27:00:00:00 REACHABLE
192.168.0.6 dev vxlan-80 lladdr fa:16:3e:e1:30:c8 PERMANENT
172.17.0.2 dev docker0 lladdr 02:42:ac:11:00:02 STALE
192.168.56.3 dev eth1  FAILED
192.168.1.1 dev brqcb225471-1f lladdr 30:fc:68:41:12:c6 STALE
```

查看网络namespace:

```
fgp@controller:~$ sudo ip netns ls
qrouter-24bf83c7-f61d-496b-8115-09f0f3d64d21
qdhcp-9284d7a8-711a-4927-8a10-605b34372768
qdhcp-cb225471-1f85-4771-b24b-a4a7108d93a4
```

进入某个网络命名空间:

```
fgp@controller:~$ sudo ip netns exec qrouter-24bf83c7-f61d-496b-8115-09f0f3d64d21 bash
root@controller:~# ifconfig
qg-0d258e6d-83 Link encap:Ethernet  HWaddr fa:16:3e:93:6f:a3
          inet addr:172.16.1.101  Bcast:172.16.1.255  Mask:255.255.255.0
          inet6 addr: fe80::f816:3eff:fe93:6fa3/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:1035 errors:0 dropped:0 overruns:0 frame:0
          TX packets:16 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:102505 (102.5 KB)  TX bytes:1200 (1.2 KB)

```

## ss

## nethogs

## ipset

## iptables/iptables-apply/iptables-restore/iptables-save

## python -m SimpleHTTPServer

## ftp/lftp

## curl

## wget

## axel

未完待续

