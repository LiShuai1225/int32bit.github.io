---
layout: post
title: 记一次主机被攻击的排查过程及分析
subtitle: 每秒几万的UDP flood攻击
catalog: true
tags:
     - Linux
---


## 排查过程

今天收到告警，我在UOS的远程主机一直在对外UDP flood攻击，每秒发送几万的报文。我赶紧登录主机，一定要想探个究竟。首先使用`tcpdump`命令抓包：
![tcpdump命令输出结果](/img/posts/记一次主机被攻击的排查过程/tcpdump.jpg)
可见病毒不断的发送数据包的过程，我们需要找到这个进程，我推测该病毒一定是不断循环执行发送指令的(没有使用nethogs是由于系统没有预装该包，网络已经受限），因此CPU资源应该会占用比较高，因此使用`top`命令查看，运行结果如图：
![top命令输出结果](/img/posts/记一次主机被攻击的排查过程/top.jpg)
从图中发现，`netstat`命令CPU资源占用率非常高，因此嫌疑非常大，看看是哪个进程启动的这个netstat进程，使用`pstree`查看：
![pstree命令输出结果](/img/posts/记一次主机被攻击的排查过程/pstree.jpg)
我们发现是`init`进程启动的，开启了10个进程，不是我们系统进程启动的，那一定是攻击者直接启动的，并且是通过远程`ssh root`账号登录的。netstap是系统标准命令，正常的话不会主动发送远程包，那会不会这个程序被篡改了呢？我们使用which命令和stat命令检查下：
![stat命令输出结果](/img/posts/记一次主机被攻击的排查过程/stat.jpg)
果然这个文件于`2016-04-16 21:14:28.811288999 +0800`被修改过，因此问题已经很明显，运行的netstat是被篡改（或者替换）过的，通过系统命令伪装！

追踪问题根源，一定是root密码被攻击了（**ubuntu server 我记得默认是不开启root远程登录的，UOS镜像默认是打开的==**），我们查看下日志：

```bash
sudo cat /var/log/auth.log|wc -l
```
结果有`129336`条记录，我的虚拟机创建没有几天，怎么会有那么多记录，一定是攻击者远程暴力破解的结果，查看auth.log:
![auth.log部分内容](/img/posts/记一次主机被攻击的排查过程/auth_log.jpg)
可见确实是通过远程ssh暴力破解root密码的。
接下来登录root账户，看是否有什么线索，查看history命令结果:
![history输出结果](/img/posts/记一次主机被攻击的排查过程/history.jpg)
哈哈，这个病毒也太草率了吧，**居然没有清空执行的历史命令！**，作案现场没有彻底破坏，留下了所有的线索，接下来分析下这个病毒到底做了什么手脚！

## 病毒分析

* 33-34：运行`ifconfig`和`ethtool eth0`命令查看网卡信息
* 35-38：关闭iptables和防火墙
* 39：清空所有的iptables规则，相当于开放了主机所有端口
* 40-41：从远处主机下载伪装程序netstat，保存到/etc目录（为什么保存到/etc?有知道的麻烦告知下）
* 43-44：赋予netstat可执行权限，并运行
* 45-47：把netstat写到rc.local中，设为启动脚本
* 48：设置启动关闭iptables
* 49-52：复制wget程序副本为`.ooet`,赋予755权限，并利用chattr设置为不可修改，然后删除原来的wget程序！(这一步想做什么手脚呢？）
* 53：清空histroy文件。哈哈，攻击者明明执行了历史记录清空啊，怎么还会留下蛛丝马迹呢，他没有想到bash history是有缓存的，一是bash执行的命令会保存到内存中，只有当退出时，才会写到.bash_histroy文件中，攻击者删除了之前的命令，但他执行的命令却留下了！二是可能存在磁盘缓存，攻击者并没有执行sync命令，可能导致有缓存。通常的做法彻底清空history：

```bash
history -w # 强制写入history文件
history -c # 清空记录
echo >$HISTFILE # 清空histroy文件
sync # flush到磁盘中
```
* 54-58：杀掉所有的getty进程，并删除`/usr/bin/bsd-port/getty`,写入一个空文件做伪装，并设置成不可修改。
* 59：再次尝试清空命令执行历史记录，显然还是不成功！
* 60-61： 执行ls命令和history。

可见这个病毒通过远程ssh登录主机，下载病毒软件并替换系统标准命令进行伪装，并开放了关闭了系统的所有防火墙，便于进一步攻击。

## 总结

这次只是远程的虚拟机被攻击，带宽是受限的，造成的危害还不是很大，如果是生产机，则损失严重了。为了预防这种情况再次发生，需要注意以下几点：

* 不要开启远程ssh root登录权限；
* 设置合适的安全组，比如对ip进行过滤等；
* 设置强密码，包括大小写、数字、特殊字符，并且尽可能长，保证暴力没法破解。
* 使用跳板机登录，生产机若没有必要，不需要连外网。

另外，以上分析的命令可能只是一部分缓存的，攻击者尝试了多次清空历史记录，可能部分记录被删除了。

**最后，感谢公司前辈的技术指导！**


